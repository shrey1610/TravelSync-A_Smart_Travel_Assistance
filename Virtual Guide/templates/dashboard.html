{% extends "headers.html" %}
{% block content %}
<!-- Main Content -->
<main>
  <div class="container">
    <h1>Weather Information</h1>
    <h5><b>Location:</b> {{weather_data['resolvedAddress']}}</h5>
    <table class="table table-striped">
      <thead>
        <tr>
          <th>Date</th>
          <th>Current Weather Conditions</th>
          <th>Max Temperature (in °C)</th>
          <th>Min Temperature (in °C)</th>
          <th>Precipitation Probability</th>
          <th>Humidity</th>
          <th>Weather Alerts</th>
        </tr>
      </thead>
      <tbody>
        {% for weather_data_item in weather_data['days'] %}
        <tr>
          <td>{{ weather_data_item['datetime'] }}</td>
          <td>{{ weather_data_item['conditions'] }}</td>
          <td>{{ weather_data_item['tempmax'] }}</td>
          <td>{{ weather_data_item['tempmin'] }}</td>
          <td>{{ weather_data_item['precipprob'] }}</td>
          <td>{{ weather_data_item['humidity'] }}</td>
          <td>{{ weather_data_item['description'] }}</td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
  <div class="container">
    <!-- Paragraph of plan with markdown syntax -->
    <h1>Travel Assistant</h1>


    <div id="markdown-content">{{ plan }}</div>
  </div>

  <!-- Hotels at Destination -->
  <div class="md-4 pd container">
    <h5>
      For Hotels & Flight Booking:
      <a style="text-decoration: none" href="https://www.booking.com" target="_blank">
        <button type="button" class="btn btn-light">
          Click Here
        </button>
      </a>
    </h5>
  </div>

  <!-- Centered Download Button -->
  <div class="text-center my-4">
    <button id="download" class="btn btn-primary">Download as Text File</button>
  </div>
</main>

<!-- Download libraries -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"
  integrity="sha512-GsLlZN/3F2ErC5ifS5QtgpiJtWd43JWSuIgh7mbzZ8zBps+dvLusV+eNQATqgA/HdeKFVgA5v3S/cIrLF7QnIg=="
  crossorigin="anonymous" referrerpolicy="no-referrer"></script>

<!-- Alert timeout script -->
<script>
  setTimeout(function () {
    const alerts = document.querySelectorAll(".alert");

    alerts.forEach(function (alert) {
      // Set opacity to 0 to initiate the transition
      alert.style.opacity = 0;
    });

    // After the transition duration, remove the alert elements
    setTimeout(function () {
      alerts.forEach(function (alert) {
        alert.style.display = "none";
      });
    }, 1000); // Adjust this delay to match your transition duration (in this case, 1 second)
  }, 5000);
</script>

<!-- Markdown rendering script -->
<script src="https://cdn.jsdelivr.net/npm/markdown-it@11.0.1/dist/markdown-it.min.js"></script>
<script>
  // Create a Markdown parser
  const md = window.markdownit();

  // Convert the Markdown text to HTML
  const html = md.render(
    document.getElementById("markdown-content").textContent
  );

  // Insert the converted HTML into the document
  document.getElementById("markdown-content").innerHTML = html;
</script>

<!-- Text file download script -->
<script>
  document.getElementById('download').addEventListener('click', function() {
    // Extract text content from the <main> element
    const element = document.querySelector('main');

    // Create a formatted text content
    let textContent = '';

    // Add a title
    textContent += '=== Travelsync Itinerary ===\n\n';

    // Add Weather Information
    textContent += '=== Weather Information ===\n';
    textContent += `Location: ${document.querySelector('h5 b').nextSibling.textContent.trim()}\n\n`;

    // Add Weather Table
    const table = document.querySelector('table');
    const rows = table.querySelectorAll('tr');
    rows.forEach((row, index) => {
      const cells = row.querySelectorAll('th, td');
      const rowText = Array.from(cells).map(cell => cell.textContent.trim()).join(' | ');
      textContent += rowText + '\n';
      if (index === 0) textContent += '-'.repeat(rowText.length) + '\n'; // Add a separator after the header
    });
    textContent += '\n';

    // Add Virtual Guide
    textContent += '=== Travel Assistant ===\n';
    textContent += document.getElementById('markdown-content').textContent.trim() + '\n\n';

    // Add Hotels and Flight Booking
    textContent += '=== Hotels & Flight Booking ===\n';
    textContent += 'For bookings, visit: https://www.booking.com\n\n';

    // Add a footer
    textContent += '=== End of Itinerary ===\n';
    textContent += 'Generated by Travelsync\n';

    // Create a Blob with the formatted text content
    const blob = new Blob([textContent], { type: 'text/plain' });

    // Create a link element to trigger the download
    const link = document.createElement('a');
    link.href = URL.createObjectURL(blob);
    link.download = 'itinerary.txt'; // File name
    link.click();

    // Clean up the URL object
    URL.revokeObjectURL(link.href);
  });
</script>
{% endblock %}
</body>
</html>